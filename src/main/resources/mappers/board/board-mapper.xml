<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="boardMapper">

	<resultMap 				id="boardResultMap" type="BoardDto">
		<id 				column="board_no" 			property="boardNo" />
		<result 		column="regist_emp" 		property="registEmp" />
		<result 		column="modify_emp" 		property="modifyEmp" />
		<result 		column="regist_date" 		property="registDate" />
		<result 		column="modify_date" 		property="modifyDate" />
		<result 		column="title" 					property="title" />
		<result 		column="content" 				property="content" />
		<result 		column="read_count" 		property="readCount" />
		<result 		column="status"					property="status" />
		<result 		column="category" 			property="category" />
		<result 		column="attachment_yn"	property="attachmentYN" />
		<result			column="profile_url"		property="profileURL" />
		<collection ofType="AttachmentDto" 	property="attachmentList">
			<id 			column="file_no" 				property="fileNo" />
			<result 	column="origin_name" 		property="originName" />
			<result 	column="enroll_date" 		property="enrollDate" />
			<result 	column="modify_name" 		property="modifyName" />
			<result 	column="attach_path" 		property="attachPath" />
			<result 	column="status" 				property="status" />
			<result 	column="ref_type" 			property="refType" />
			<result 	column="ref_no" 				property="refNo" />
		</collection>
	</resultMap>


	<!-- 총게시글 갯수조회(STATUS ="Y") -->
	<select id="selectTotalBoardCount" parameterType="map" resultType="_int">
		select count(*) totalBoards
		  from tb_board
		  left outer join member on (user_no = tb_board.modify_emp)
		 where tb_board.status = 'Y'
		<if test="category != null">
			<choose>
				<when test="category.equals('normal')">
					and category is null
				</when>
				<when test="category.equals('department') and department.equals('')">
					and category is not null
				</when>
				<when test="category.equals('department') and !department.equals('')">
					and category = #{department}
				</when>
			</choose>
		</if>
		<if test="condition != null and keyword != null">
			<choose>
				<when test="(condition.equals('') or condition.equals('all')) and !keyword.equals('')">
					and 
							(title like 	 		'%' || #{keyword} || '%'
					 		 or content like 		'%' || #{keyword} || '%'
					 		 or user_name like 		'%' || #{keyword} || '%'
					 		 )
				</when>
				<when test="condition.equals('title') and !keyword.equals('')">
					and title like 	 				 '%' || #{keyword} || '%'
				</when>
				<when test="condition.equals('content') and !keyword.equals('')">
					and content like 			 	 '%' || #{keyword} || '%'
				</when>
				<when test="condition.equals('writer') and !keyword.equals('')">
					and user_name like 		 		 '%' || #{keyword} || '%'
				</when>
			</choose>
		</if>
	</select>

	<!-- 게시글 목록조회 -->
	<select id="selectBoardList" parameterType="map" resultMap="boardResultMap">
		select
					 board_no
					,title
					,profile_url
					,user_name 			"modify_emp"
					,to_char(tb_board.modify_date, 'YYYY-MM-DD') "modify_date"
					,read_count
					,code_name 			"category"
					,(
						 select count(*) totalAttachments
						   from attachment
						  where status 		= 'Y'
						    and ref_type 	= 'BD'
						    and ref_no 		= tb_board.board_no
						) "attachment_yn"
			from tb_board
			left outer join member     on (user_no = regist_emp)
			left outer join tb_group   on (
                                 		 group_code = 'DEPT01' 
                                 		 and code	  = category
                                 		 )
			left outer join attachment on (ref_no = board_no)
     where tb_board.status = 'Y'  
     <if test="category != null">
			<choose>
				<when test="category.equals('normal')">
					and category is null
				</when>
				<when test="category.equals('department') and department.equals('')">
					and category is not null
				</when>
				<when test="category.equals('department') and !department.equals('')">
					and category = #{department}
				</when>
			</choose>
		</if>
		<if test="condition != null and keyword != null">
			<choose>
				<when test="(condition.equals('') or condition.equals('all')) and !keyword.equals('')">
					and 
							(title like 	 		'%' || #{keyword} || '%'
					 		 or content like 		'%' || #{keyword} || '%'
					 		 or user_name like 		'%' || #{keyword} || '%'
					 		 )
				</when>
				<when test="condition.equals('title') and !keyword.equals('')">
					and title like 	 				'%' || #{keyword} || '%'
				</when>
				<when test="condition.equals('content') and !keyword.equals('')">
					and content like 				'%' || #{keyword} || '%'
				</when>
				<when test="condition.equals('writer') and !keyword.equals('')">
					and user_name like 				'%' || #{keyword} || '%'
				</when>
			</choose>
		</if>
     order by board_no desc
	</select>
	
	<!-- 게시글 등록 -->
	<insert id="insertBoard" parameterType="BoardDto">
		insert
			into tb_board
					 (
					   board_no
					  ,regist_emp
					  ,modify_emp
					  ,title
					  ,content
					  ,category
					 )
		values 
					(
					  seq_bno.nextval
					 ,#{registEmp}
					 ,#{modifyEmp}
					 ,#{title}
					 ,#{content}
					 ,#{category}
					)
	</insert>
	
	<!-- 첨부파일 등록 -->
	<insert id="insertAttachment" parameterType="AttachmentDto">
		insert
			into attachment
					 (
					   file_no
					  ,origin_name
					  ,modify_name
					  ,attach_path
					  ,ref_type
					  ,ref_no
					 )
		values 
					(
					  seq_ano.nextval
					 ,#{originName}
					 ,#{modifyName}
					 ,#{attachPath}
					 ,#{refType}
					 ,seq_bno.currval
					)
	</insert>
	
	<!-- 게시글 수정 -->


  
</mapper>
